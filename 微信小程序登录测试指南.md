# 🔧 微信小程序登录测试指南

## ❌ 错误说明

**错误信息**：`此账号未注册 uni-id-account-not-exists`

**错误原因**：尝试登录一个在 uni-id 系统中不存在的账号

**出现位置**：`store.js:99` - 在更新用户信息时

---

## ✅ 解决方案

### 方案1：在模拟器中使用账号密码登录（推荐）

微信小程序**模拟器**中的微信登录功能有限，建议使用**账号密码登录**：

#### 步骤1：注册新账号

1. 打开小程序
2. 进入登录页面
3. 点击页面底部的 **"注册账号"** 链接
4. 填写注册信息：
   ```
   用户名：testuser（或任意用户名）
   密码：test123（至少6位，包含字母和数字）
   确认密码：test123
   ```
5. 勾选 **"我已阅读并同意用户协议"**
6. 点击 **"注册"** 按钮
7. 注册成功后会自动登录

#### 步骤2：后续登录

注册成功后，下次直接使用注册的账号密码登录即可。

---

### 方案2：在真机上测试微信登录

如果需要测试**微信登录**功能，必须在**真机**上测试：

#### 准备工作

1. 确保你的小程序已在微信公众平台注册
2. `manifest.json` 中的 `appid` 已正确配置
3. uni-id 配置文件中的 `appsecret` 已正确填写

#### 测试步骤

1. 使用微信开发者工具将小程序**真机预览**
2. 手机微信扫码打开
3. 在登录页面点击 **微信登录** 按钮
4. 首次登录会自动创建账号（自动注册）
5. 后续登录会直接使用微信账号

---

### 方案3：创建管理员账号（可选）

如果需要管理员权限（访问管理员面板）：

1. 访问注册管理员页面：
   ```
   /uni_modules/uni-id-pages/pages/register/register-admin
   ```

2. 填写管理员信息并注册

3. 登录后会自动跳转到管理员面板

---

## 🧪 完整测试流程

### 1. 首次使用（模拟器测试）

```
Step 1: 打开小程序
   ↓
Step 2: 首页点击"开始评估"
   ↓
Step 3: 提示未登录，点击"去登录"
   ↓
Step 4: 登录页面点击"注册账号"
   ↓
Step 5: 填写注册信息并提交
   ↓
Step 6: 注册成功，自动登录并返回首页
   ↓
Step 7: 再次点击"开始评估"，成功进入
```

### 2. 已有账号（再次打开）

```
Step 1: 打开小程序
   ↓
Step 2: 如果token未过期，自动登录
   ↓
Step 3: 如果token过期，进入登录页面
   ↓
Step 4: 输入账号密码登录
   ↓
Step 5: 登录成功，进入首页
```

---

## 🔍 常见问题

### Q1: 为什么模拟器中微信登录不可用？

**A**: 微信小程序模拟器的微信登录功能受限，需要在真机上测试。开发阶段建议使用账号密码登录。

### Q2: 我已经注册了，但还是提示账号未注册？

**可能原因**：
1. 使用了错误的账号
2. 数据库中的用户记录被删除
3. uni-id 配置问题导致无法读取用户信息

**解决方法**：
1. 确认输入的账号密码正确
2. 重新注册一个新账号测试
3. 检查 uniCloud 控制台的 `uni-id-users` 数据表

### Q3: 提示"Invalid uni-id config file"？

**解决方法**：
1. 检查 uni-id 配置文件是否正确：
   ```
   uni_modules/uni-config-center/uniCloud/cloudfunctions/common/uni-config-center/uni-id/config.json
   ```
2. 确保 `uni-config-center` 公共模块已上传到云端：
   - 右键 `uni_modules/uni-config-center`
   - 选择 **"上传公共模块"**
3. 重新上传 `uni-id-co` 云对象

### Q4: 注册成功但登录失败？

**排查步骤**：
1. 打开 uniCloud Web 控制台
2. 查看 `uni-id-users` 数据表
3. 确认用户记录是否存在
4. 查看云函数日志，检查具体错误信息

---

## 📋 验证清单

在完成测试前，请确认：

- [ ] 已创建测试账号（使用注册功能）
- [ ] 可以使用账号密码成功登录
- [ ] 登录后能正常访问个人中心
- [ ] 登录后能正常进行评估
- [ ] 登录状态在刷新后保持（token未过期）
- [ ] 退出登录功能正常
- [ ] （可选）真机上微信登录正常

---

## 🚀 快速测试命令

### 测试1: 验证 uni-id 配置

在小程序中调用测试云函数：

```javascript
uniCloud.callFunction({
  name: 'testConfig',
  success: (res) => {
    console.log('配置验证结果:', res.result)
  }
})
```

### 测试2: 查看当前登录状态

在小程序控制台运行：

```javascript
console.log('Token:', uni.getStorageSync('uni_id_token'))
console.log('用户信息:', uni.getStorageSync('uni-id-pages-userInfo'))
```

---

## 📞 需要帮助？

如果问题依然存在：

1. 查看浏览器/微信开发者工具控制台的完整错误信息
2. 检查 uniCloud Web 控制台的云函数日志
3. 提供以下信息：
   - 错误的完整堆栈信息
   - 使用的登录方式（账号密码/微信/手机验证码）
   - 是在模拟器还是真机测试
   - uniCloud 控制台的错误日志

---

## 📝 备注

- **开发阶段**：建议使用账号密码登录，方便测试
- **生产环境**：建议启用微信登录，提升用户体验
- **安全性**：定期更换 `passwordSecret` 和 `tokenSecret`（生产环境必须）
- **Token 有效期**：默认 30 天（2592000 秒），可在配置文件中调整

---

## ✅ 修复完成提示

我已经改进了 `store.js` 中的错误处理代码，现在当遇到"账号未注册"错误时，会在控制台输出更友好的提示信息，而不会导致页面崩溃。

**重新编译小程序后生效**。

